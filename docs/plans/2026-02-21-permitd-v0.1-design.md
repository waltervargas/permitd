# permitd v0.1 Design

## Overview

permitd is an OIDC authorization gateway powered by Cedar. It accepts GitHub Actions OIDC JWTs, validates them, evaluates fine-grained permissions using Cedar policies, and proxies authorized requests to a local Podman Unix socket.

## Architecture

```
GitHub Actions (OIDC JWT)
  → Cloudflare Proxy (TLS)
    → permitd (plain HTTP, 0.0.0.0:8080)
      → JWT validation (JWKS from GitHub)
      → Route matching (routes.toml)
      → Cedar policy evaluation
      → Unix socket proxy (/run/podman/podman.sock)
```

## Simplifications from PRD

| Area | PRD | v0.1 |
|------|-----|------|
| TLS | Built-in via axum-server + rustls | None — behind Cloudflare |
| Policy reload | File watching via notify | Restart only |
| Upstream | Unix socket + TCP | Unix socket only |
| Resource extraction | path, query, body, wildcard, static | path, query, wildcard, static (no body parsing) |
| License | Apache-2.0 (corrected from MIT in repo) | Apache-2.0 |

## Key Design Decisions

1. **Hyper raw proxy**: Direct hyper + custom Unix socket connector (~30 lines) for zero-copy streaming. No hyperlocal dependency (stale for hyper 1.x).

2. **No TLS**: Cloudflare handles TLS termination. permitd listens on plain HTTP.

3. **No hot-reload**: Restart the service to pick up policy changes. Simplest for v0.1.

4. **No body extraction**: Create operations use wildcard resources. Path and query extraction cover most authorization needs.

5. **Entity UID = repository**: Two concurrent workflows from the same repo share the same Cedar principal. Authorization is at repo level.

## Cedar Model

- Principal: `Permitd::Workflow` with attributes from GitHub OIDC claims (repository, repository_owner, ref, actor, environment, etc.)
- Actions: `containers:{create,start,stop,remove,list,inspect,logs,exec}`, `images:{pull,list,remove,build}`, `volumes:{create,remove,list}`, `networks:{create,remove,list}`
- Resources: `Permitd::Container`, `Permitd::Image`, `Permitd::Volume`, `Permitd::Network`

## Module Structure

```
src/
├── main.rs           # Entry + CLI dispatch
├── cli.rs            # Clap definitions
├── config.rs         # TOML config
├── error.rs          # Error types
├── jwt/
│   ├── mod.rs
│   ├── jwks.rs       # JWKS fetch + cache
│   ├── validation.rs # JWT validation
│   └── claims.rs     # GitHub claims struct
├── cedar/
│   ├── mod.rs
│   ├── engine.rs     # Policy/schema loading
│   ├── entities.rs   # Claims → Cedar entity
│   └── eval.rs       # Authorization evaluation
├── routing/
│   ├── mod.rs
│   ├── mapping.rs    # routes.toml parsing
│   ├── matcher.rs    # Path pattern matching
│   └── resource.rs   # Resource extraction
├── proxy/
│   ├── mod.rs
│   └── upstream.rs   # Unix socket proxy
└── server/
    ├── mod.rs
    ├── handler.rs    # Catch-all handler
    └── middleware.rs  # Auth middleware
```

## Dependencies

Core: axum, cedar-policy 4, clap 4, hyper 1, hyper-util, http-body-util, jsonwebtoken 9, reqwest 0.12, serde, serde_json, tokio, toml, tracing, tracing-subscriber, thiserror 2, tower, tower-http, bytes

Removed from PRD: axum-server (no TLS), notify (no hot-reload)

Dev: wiremock, tempfile

## Build Order

1. cargo init, Cargo.toml with dependencies
2. error.rs — AppError enum
3. config.rs — TOML config + test
4. cli.rs — Clap CLI + main.rs wiring
5. jwt/claims.rs — GitHub claims struct + test
6. jwt/jwks.rs — JWKS fetching + caching + test
7. jwt/validation.rs — Full JWT validation + test
8. cedar/engine.rs — Schema + policy loading + test
9. cedar/entities.rs — Claims → Cedar entity + test
10. cedar/eval.rs — Authorization evaluation + test
11. routing/mapping.rs — routes.toml parsing + test
12. routing/matcher.rs — Path pattern matching + test
13. routing/resource.rs — Resource extraction + test
14. proxy/upstream.rs — Unix socket proxy + test
15. server/middleware.rs — Auth middleware chain
16. server/handler.rs — Catch-all + health checks
17. main.rs — Wire everything, implement subcommands
18. Integration tests
19. Example files, Dockerfile, systemd unit
